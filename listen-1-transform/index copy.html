<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MIDI Visualizer and RNN</title>
    <script src="https://cdn.jsdelivr.net/npm/@magenta/music@^1.0.0"></script>
  </head>
  <body>
    <canvas id="viz"></canvas>
    <button id="playBtn">Play/Stop</button>
    <button id="rnnBtn">Activate RNN</button>
    <canvas id="RNNviz"></canvas>
    <script type="module">
      // const mm = magenta.music;

      // Function to convert a MIDI file to a NoteSequence
      async function convertMidiToNoteSequence(midiFile) {
        // Load the MIDI file as a binary string
        const midi = await fetch(midiFile).then((response) =>
          response.arrayBuffer()
        );
        // Convert the binary string to a NoteSequence
        return mm.midiToSequenceProto(midi);
      }

      const player = new mm.SoundFontPlayer(
        "https://storage.googleapis.com/magentadata/js/soundfonts/sgm_plus"
      );
      const rnn_steps = 20; // The number of steps the RNN should generate
      const rnn_temperature = 1.5; // The temperature of the RNN's randomness

      // Initialize the model
      const music_rnn = new mm.MusicRNN(
        "https://storage.googleapis.com/magentadata/js/checkpoints/music_rnn/basic_rnn"
      );
      await music_rnn.initialize();

      const rnnPlayer = new mm.Player();

      // Load your MIDI file
      let kraft;
      convertMidiToNoteSequence(
        "../assets/Kraftwerk_Radio_Aktivitaet-short.mid"
      )
        .then((sequence) => {
          kraft = sequence;
          // Visualizer setup
          const config = {
            noteHeight: 6,
            pixelsPerTimeStep: 30, // like a note width
            noteSpacing: 1,
            noteRGB: "8, 41, 64",
            activeNoteRGB: "240, 84, 119",
          };
          const visualizer = new mm.Visualizer(
            kraft,
            document.getElementById("viz"),
            config
          );
        })
        .catch((error) =>
          console.error("Error converting MIDI to NoteSequence:", error)
        );

      function filterValidNotes(noteSequence) {
        const MIN_PITCH = 21; // MIDI pitch for A0
        const MAX_PITCH = 108; // MIDI pitch for C8

        noteSequence.notes = noteSequence.notes.filter((note) => {
          return note.pitch >= MIN_PITCH && note.pitch <= MAX_PITCH;
        });

        return noteSequence;
      }

      // Usage
      let validSequence = filterValidNotes(kraft);

      document.getElementById("playBtn").addEventListener("click", () => {
        if (player.isPlaying()) {
          player.stop();
        } else {
          player.start(validSequence);
        }
      });

      document.getElementById("rnnBtn").addEventListener("click", () => {
        const qns = mm.sequences.quantizeNoteSequence(validSequence, 4);
        music_rnn
          .continueSequence(qns, rnn_steps, rnn_temperature)
          .then((sample) => rnnPlayer.start(sample));
      });
    </script>
  </body>
</html>
